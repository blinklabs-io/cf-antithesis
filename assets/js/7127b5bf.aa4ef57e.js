"use strict";(globalThis.webpackChunkmy_website=globalThis.webpackChunkmy_website||[]).push([[8757],{8453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var s=n(6540);const r={},i=s.createContext(r);function o(e){const t=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:t},e.children)}},9816:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"user/ci","title":"Continuous Integration","description":"Moog can be easily integrated in a Continuous Integration process to trigger Antithesis tests run on demand. Here is some example configuring GitHub actions but this should be straightforward to adapt to any other kind of CI engine.","source":"@site/docs/user/ci.md","sourceDirName":"user","slug":"/user/ci","permalink":"/moog/docs/user/ci","draft":false,"unlisted":false,"editUrl":"https://github.com/cardano-foundation/moog/tree/main/docs/docs/user/ci.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Usage","permalink":"/moog/docs/user/usage"},"next":{"title":"Secrets management tips","permalink":"/moog/docs/user/secrets-management"}}');var r=n(4848),i=n(8453);const o={},a="Continuous Integration",c={},d=[];function l(e){const t={a:"a",code:"code",em:"em",h1:"h1",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"continuous-integration",children:"Continuous Integration"})}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.em,{children:"Moog"})," can be easily integrated in a ",(0,r.jsx)(t.em,{children:"Continuous Integration"})," process to trigger Antithesis tests run on demand. Here is some example configuring ",(0,r.jsx)(t.a,{href:"https://github.com/features/actions",children:"GitHub actions"})," but this should be straightforward to adapt to any other kind of CI engine."]}),"\n",(0,r.jsx)(t.p,{children:"These tests are triggered every 6 hours"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"name: \"Antithesis Tests\"\non:\n  schedule:\n    # run every 6 hours\n    - cron:  '5 1,7,13,19 * * *'\n"})}),"\n",(0,r.jsx)(t.p,{children:"Linux/x86 is currently the best supported platform by Moog."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"jobs:\n  run-antithesis:\n    runs-on: ubuntu-latest\n"})}),"\n",(0,r.jsxs)(t.p,{children:["We need to define a number of environment variables that will be used by Moog ",(0,r.jsx)(t.em,{children:"requester"})," to request tests run. The detailed meaning of these variables is explained in the ",(0,r.jsx)(t.a,{href:"./usage",children:"usage"})," section of the documentation:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"    env:\n      MOOG_WALLET_FILE: ${{ vars.MOOG_WALLET_FILE }}\n      MOOG_MPFS_HOST: ${{ vars.MOOG_MPFS_HOST }}\n      MOOG_TOKEN_ID: ${{ vars.MOOG_TOKEN_ID }}\n      MOOG_PLATFORM: github\n      MOOG_REQUESTER: ${{ vars.MOOG_REQUESTER }}\n      MOOG_TEST_DIRECTORY: ${{ vars.MOOG_TEST_DIRECTORY }}\n"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"MOOG_WALLET_FILE"})," is the file that will store the mnemonics of the wallet used to pay transaction fees"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"MOOG_MPFS_HOST"})," is the URL of the ",(0,r.jsx)(t.a,{href:"https://cardano-foundation.github.io/mpfs/",children:(0,r.jsx)(t.em,{children:"Merkle-Patricia Forestry Service"})})," Moog shall use to retrieve information about the system's state"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"MOOG_TOKEN_ID"}),' is the identifier of the particular "database" Moog will be using (a 32-bytes hash denoting a Cardano native asset name)']}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"MOOG_PLATFORM"})," is hardcoded to ",(0,r.jsx)(t.code,{children:"github"})," as this is currently the only supported source forge"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"MOOG_REQUESTER"})," is the username under which the tests will be run. Note this name must both exist in the ",(0,r.jsx)(t.em,{children:"platform"})," and be ",(0,r.jsx)(t.a,{href:"./usage",children:"registered"})," with Moog"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"MOOG_TEST_DIRECTORY"})," points at a directory in the source code which contains a valid Antithesis ",(0,r.jsx)(t.code,{children:"docker-compose.yaml"})," configuration file for tests submission"]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["We also need to set some ",(0,r.jsx)(t.em,{children:"secrets"})," that will be used by Moog to authenticate and authorize the requests:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"      MOOG_GITHUB_PAT: ${{ secrets.MOOG_GITHUB_PAT }}\n      MOOG_REQUESTER_WALLET: ${{ secrets.MOOG_REQUESTER_WALLET }}\n"})}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"MOOG_REQUESTER_WALLET"})," is the base64-encoded JSON content of the wallet file created by ",(0,r.jsx)(t.code,{children:"moog wallet create"}),", typically the ",(0,r.jsx)(t.em,{children:"mnemonics"})," (see ",(0,r.jsx)(t.a,{href:"./configuration",children:"Configuration"}),")"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"MOOG_GITHUB_PAT"})," is obviously specific to ",(0,r.jsx)(t.code,{children:"github"})," platform and is a ",(0,r.jsx)(t.em,{children:"Personal Authentication Token"})," used to query Github API"]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"We set a timeout of 10 hours for this job as we'll be waiting for test execution result, adjust accordingly"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"    timeout-minutes: 600\n"})}),"\n",(0,r.jsxs)(t.p,{children:["These are the permissions we need for ",(0,r.jsx)(t.em,{children:"this job"})," and which will be set for the particular token attached to it"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"    # required permissions to be able to push to registry\n    permissions:\n      packages: write\n      contents: read\n      attestations: write\n      id-token: write\n"})}),"\n",(0,r.jsx)(t.p,{children:"Now come the sequence of actions needed to run the tests. We first do some setup for docker, and checkout the code"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"    steps:\n    - name: \ud83d\udea7 Set up Docker Buildx\n      uses: docker/setup-buildx-action@v3\n\n    - name: \ud83d\udce5 Checkout repository\n      uses: actions/checkout@v4\n      with:\n        ref: ${{ github.event.inputs.ref_name || '' }}\n\n    - name: \ud83d\udd11 Login Docker Registry\n      uses: docker/login-action@v3\n      with:\n          registry: ghcr.io\n          username: ${{ github.actor }}\n          password: ${{ secrets.GITHUB_TOKEN }}\n"})}),"\n",(0,r.jsx)(t.p,{children:"We then identify the latest available release of Moog,"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"    - id: moog\n      name: Get latest moog release tag\n      uses: pozetroninc/github-action-get-latest-release@master\n      with:\n        repository: cardano-foundation/moog\n"})}),"\n",(0,r.jsx)(t.p,{children:"retrieve it from GitHub packages,"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'    - name: Download moog from latest release\n      uses: robinraju/release-downloader@v1.10\n      with:\n        repository: cardano-foundation/moog\n        tag: ${{ steps.moog.outputs.release }}\n        fileName: "moog-*-linux64.tar.gz"\n        out-file-path: "."\n        extract: true\n'})}),"\n",(0,r.jsxs)(t.p,{children:["and ultimately install ",(0,r.jsx)(t.code,{children:"moog"})," executable to be available for later steps."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'    - name: Install moog\n      run: |\n        echo "Release: ${{ steps.moog.outputs.release }}"\n        sudo install -m 0755 moog /usr/local/bin/moog\n        moog --version\n'})}),"\n",(0,r.jsx)(t.p,{children:"The wallet's secret (mnemonics) are extracted and temporarily stored in the local filesystem for use by Moog."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"    - name: Configure moog wallet\n      run: printf '%s' \"$MOOG_REQUESTER_WALLET\" | base64 --decode > $MOOG_WALLET_FILE\n"})}),"\n",(0,r.jsx)(t.p,{children:"Finally, we are able to submit our test request:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"    - name: Submit test\n      id: request\n      run: |\n        set -euo pipefail\n"})}),"\n",(0,r.jsxs)(t.p,{children:["This part of the script computes the trial number for this test run. Test runs are identified by the Git commit SHA plus a trial number in order to avoid duplicate requests. We use the ",(0,r.jsx)(t.code,{children:"moog facts test-runs"})," command parameterised by the user id to retrieve relevant data."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'        TRY=$(moog facts test-runs --whose $MOOG_REQUESTER | jq \'map(select(.key.commitId == "${{ github.sha }}")) | length\')\n        TRY=$(($TRY + 1)) # start with try=1\n        echo "TRY=$TRY"\n'})}),"\n",(0,r.jsxs)(t.p,{children:["At last, we request test execution. ",(0,r.jsx)(t.code,{children:"$DURATION"})," should be set to the requested duration (in hours) of the test run. If all goes well transaction and test run identifiers should be printed."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'        RESULT=$(moog requester create-test -d "$MOOG_TEST_DIRECTORY" \\\n          -c ${{ github.sha }} \\\n          -r "$GITHUB_REPOSITORY" \\\n          --try $TRY \\\n          -t $DURATION)\n        echo $RESULT\n\n        # Passing -e and -r in separate jq calls ensures we both unwrap\n        # the string quotes and fail if the json isn\'t as expected.\n        ID=$(echo $RESULT | jq -e .value.testRunId | jq -r .)\n        TXID=$(echo $RESULT | jq -e .txHash | jq -r .)\n        echo "id=$ID" >> "$GITHUB_OUTPUT"\n        echo "txHash=$TXID" >> "$GITHUB_OUTPUT"\n'})}),"\n",(0,r.jsxs)(t.p,{children:["The last part of the job simply waits for the result to be published by the Antithesis agent, repeatedly running ",(0,r.jsx)(t.code,{children:'moog facts test-runs --test-run-id "$ID"'})," command and checking its output to tell whether or not the test is finished."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'    - name: Wait for results\n      run: timeout $((($DURATION + 1) * 3600)) ./scripts/wait-for-test.sh "${{ steps.request.outputs.id }}"\n'})}),"\n",(0,r.jsxs)(t.p,{children:["When the test completes, final result is printed in the logs along with the URL where the detailed Antithesis report can be found. The job succeeds if and only if the test ",(0,r.jsx)(t.code,{children:"outcome"})," is a success."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'final result: [{"id":"722bb7a35a6b9318536b6750751e5f13ed6e1dcc83fd113d98cf4e4b02ea1e14","key":{"commitId":"0ce357a0faabf970eb38d7191bf5f8bb8a36684b","directory":"docker/testnet","platform":"github","repository":{"organization":"pragma-org","repo":"amaru"},"requester":"abailly","try":2,"type":"test-run"},"slot":107737174,"value":{"duration":3,"from":{"from":{"duration":3,"faults_enabled":true,"phase":"pending","signature":"d1a70d0f60d358330f89d58c50f9971f16c54223d31932b3335561cd4efaecf4f9145c0f48f7098a66597062d7b558fe7785276cf67676bad0c787306b54be00"},"phase":"accepted"},"outcome":"failure","phase":"finished","url":"https://cardano.antithesis.com/report/F7dbAImlN-ZGCzC2_rkNKayN/Jw7X8mEfgH6iFqDy1W9jEDeSJ9rQWwAGN_y_eZ3oHwk.html?auth=v2.public.eyJuYmYiOiIyMDI1LTExLTE3VDIxOjU2OjEwLjI0NTMxNzAxNVoiLCJzY29wZSI6eyJSZXBvcnRTY29wZVYxIjp7ImFzc2V0IjoiSnc3WDhtRWZnSDZpRnFEeTFXOWpFRGVTSjlyUVd3QUdOX3lfZVozb0h3ay5odG1sIiwicmVwb3J0X2lkIjoiRjdkYkFJbWxOLVpHQ3pDMl9ya05LYXlOIn19ffVFhhos4dhGHfry7p0K54c_cOHbkxnJW3Il926JxHeMIh3rRZgjuBbMUlyfVCl7sEG1Sc6nNRHr36gTOfM0xAQ"}}]\n> **Note:** The following output is an example of a failed test run, shown to demonstrate the output format. In a successful run, you should see a message indicating that all tests passed.\nfailed\nError: Process completed with exit code 1.\n'})})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}}}]);