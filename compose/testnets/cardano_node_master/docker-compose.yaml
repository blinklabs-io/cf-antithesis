---

x-cardano-node: &cardano-node
  image: ghcr.io/intersectmbo/cardano-node:latest
  volumes:
    - tracer:/tracer

  command: >
    run --topology /configs/configs/topology.json
      --config /configs/configs/config.json
      --tracer-socket-path-connect /tracer/tracer.socket
      --shelley-operational-certificate /configs/keys/opcert.cert
      --shelley-kes-key /configs/keys/kes.skey
      --shelley-vrf-key /configs/keys/vrf.skey
      --port 3000
      --host-addr 0.0.0.0
      +RTS -N -A16m -qg -qb -RTS
  depends_on:
      configurator:
        condition: service_completed_successfully

x-tracer: &tracer
  image: ${registry}${testnet}_tracer:latest
  restart: on-failure
  build:
    context: "../../tracer/"
    # ideally we would like to use a precompiled version of the tracer
    # but unfortunately it's not yet packaged in archives
    # https://github.com/IntersectMBO/cardano-node/issues/6228
    dockerfile: "Dockerfile.compiled"
    args:
      CARDANO_NODE_VERSION: "main"

x-env: &env
  POOL_ID: "0" # Placeholder required for override
  UTXO_HD_WITH: "mem"

services:
  configurator:
    image: ubuntu
    container_name: configurator
    command: ["sh", "-c", "exit 1"]
    volumes:
      - p1-configs:/configs/1
      - p2-configs:/configs/2
      - p3-configs:/configs/3
      - p4-configs:/configs/4
      - p5-configs:/configs/5
    build:
      context: "../../"
      dockerfile: "Dockerfile.configurator"

  tracer:
    <<: *tracer
    hostname: tracer.example
    container_name: tracer
    volumes:
      - tracer:/opt/cardano-tracer
    command:
       - "--config"
       - "tracer-config.yaml"

  p1:
    <<: *cardano-node
    container_name: p1
    hostname: p1.example
    volumes:
      - p1-configs:/configs
    environment:
      <<: *env
      POOL_ID: "1"
      UTXO_HD_WITH: "hd"

  p2:
    <<: *cardano-node
    container_name: p2
    hostname: p2.example
    volumes:
      - p2-configs:/configs
      - tracer:/opt/cardano-tracer
    environment:
      <<: *env
      POOL_ID: "2"

  p3:
    <<: *cardano-node
    container_name: p3
    hostname: p3.example
    volumes:
      - p3-configs:/configs
    environment:
      <<: *env
      POOL_ID: "3"

  p4:
    <<: *cardano-node
    container_name: p4
    hostname: p4.example
    volumes:
      - p4-configs:/configs
    environment:
      <<: *env
      POOL_ID: "4"
      UTXO_HD_WITH: "hd"

  p5:
    <<: *cardano-node
    container_name: p5
    hostname: p5.example
    volumes:
      - p5-configs:/configs
    environment:
      <<: *env
      POOL_ID: "5"

  s1:
    image: ${registry}${testnet}_sidecar:latest
    restart: on-failure
    container_name: s1
    hostname: s1.example
    environment:
      POOLS: "5"

  tracer-sidecar:
    image: ${registry}${testnet}_tracer-sidecar:latest
    restart: on-failure
    container_name: tracer-sidecar
    hostname: tracer-sidecar.example
    environment:
      POOLS: "5"
    volumes:
      - tracer:/opt/cardano-tracer

volumes:
  tracer:
  p1-configs:
  p2-configs:
  p3-configs:
  p4-configs:
  p5-configs:
